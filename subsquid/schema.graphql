# Core Entities

type Persona @entity {
  id: ID! # tokenId
  tokenId: BigInt! @index
  creator: String! @index
  owner: String! @index
  name: String! @index
  symbol: String! @index
  erc20Token: String! @index
  pairToken: String! @index
  agentToken: String

  # Domain and Pool Info
  domain: String! @index
  poolId: String

  # Status
  pairCreated: Boolean!
  pairAddress: String

  # Chain tracking
  chainId: Int! @index

  # Timestamps
  createdAt: DateTime!
  createdAtBlock: BigInt!
  graduationTimestamp: BigInt

  # Stats
  totalDeposited: BigInt!
  tokensSold: BigInt!
  graduationThreshold: BigInt!
  totalAgentDeposited: BigInt!
  minAgentTokens: BigInt!
  
  # Relations
  trades: [Trade!]! @derivedFrom(field: "persona")
  metadata: [PersonaMetadata!]! @derivedFrom(field: "persona")
  agentDeposits: [AgentDeposit!]! @derivedFrom(field: "persona")
  transfers: [PersonaTransfer!]! @derivedFrom(field: "persona")
  withdrawals: [TokenWithdrawal!]! @derivedFrom(field: "persona")
}

type PersonaMetadata @entity {
  id: ID! # personaId-key
  persona: Persona!
  key: String! @index
  value: String!
  updatedAt: DateTime!
  updatedAtBlock: BigInt!
}

type Trade @entity {
  id: ID! # txHash-logIndex
  persona: Persona!
  trader: String! @index
  amountIn: BigInt!
  amountOut: BigInt!
  feeAmount: BigInt!
  isBuy: Boolean! # NEW: true for buy, false for sell
  timestamp: DateTime!
  block: BigInt!
  txHash: String! @index
  chainId: Int! @index
}

type AgentDeposit @entity {
  id: ID! # personaId-user-index
  persona: Persona!
  user: String! @index
  amount: BigInt!
  timestamp: DateTime!
  withdrawn: Boolean!
  rewardsClaimed: Boolean!
  block: BigInt!
  txHash: String! @index
}

type AgentReward @entity {
  id: ID! # txHash-logIndex
  persona: Persona!
  user: String! @index
  personaTokensReceived: BigInt!
  agentTokenAmount: BigInt!
  timestamp: DateTime!
  block: BigInt!
  txHash: String! @index
}

# New entity for NFT transfers
type PersonaTransfer @entity {
  id: ID! # txHash-logIndex
  persona: Persona!
  from: String! @index
  to: String! @index
  timestamp: DateTime!
  block: BigInt!
  txHash: String! @index
  chainId: Int! @index
}

# New entity for token withdrawals
type TokenWithdrawal @entity {
  id: ID! # txHash-logIndex
  persona: Persona!
  user: String! @index
  amount: BigInt!
  timestamp: DateTime!
  block: BigInt!
  txHash: String! @index
  chainId: Int! @index
}

# Staking Entities

type StakingPool @entity {
  id: ID! # poolId
  poolId: Int! @index
  lpToken: String! @index
  allocBasisPoints: Int!
  isAgentPool: Boolean!
  personaTokenId: BigInt
  isActive: Boolean!
  totalStaked: BigInt!
  accAmicaPerShare: BigInt!
  lastRewardBlock: BigInt!
  createdAt: DateTime!
  createdAtBlock: BigInt!
  
  # Relations
  userStakes: [UserStake!]! @derivedFrom(field: "pool")
}

type UserStake @entity {
  id: ID! # poolId-user
  pool: StakingPool!
  user: String! @index
  flexibleAmount: BigInt!
  lockedAmount: BigInt!
  unclaimedRewards: BigInt!
  firstStakeAt: DateTime!
  lastStakeAt: DateTime!
  
  # Relations
  locks: [StakeLock!]! @derivedFrom(field: "userStake")
}

type StakeLock @entity {
  id: ID! # poolId-user-lockId
  userStake: UserStake!
  lockId: BigInt! @index
  amount: BigInt!
  unlockTime: DateTime! @index
  lockMultiplier: Int!
  createdAt: DateTime!
  createdAtBlock: BigInt!
  isWithdrawn: Boolean!
}

type StakingRewardClaim @entity {
  id: ID! # txHash-logIndex
  user: String! @index
  totalAmount: BigInt!
  timestamp: DateTime!
  block: BigInt!
  txHash: String! @index
}

# Bridge Entities

type BridgeActivity @entity {
  id: ID! # txHash-logIndex
  user: String! @index
  action: BridgeAction!
  amount: BigInt!
  timestamp: DateTime!
  block: BigInt!
  txHash: String! @index
  chainId: Int! @index
}

enum BridgeAction {
  WRAP
  UNWRAP
  EMERGENCY_WITHDRAW
  METRICS_UPDATE
  TOKENS_UPDATE
}

# Token Transfer tracking
type AmicaTransfer @entity {
  id: ID! # txHash-logIndex
  from: String! @index
  to: String! @index
  value: BigInt!
  timestamp: DateTime!
  block: BigInt!
  txHash: String! @index
  chainId: Int! @index
  # Context fields
  isToFactory: Boolean!
  isFromFactory: Boolean!
  isToStaking: Boolean!
  isFromStaking: Boolean!
  isToBridge: Boolean!
  isFromBridge: Boolean!
}

# Burn and Claim tracking
type AmicaClaim @entity {
  id: ID! # txHash-logIndex
  user: String! @index
  claimedToken: String! @index
  amountBurned: BigInt!
  amountClaimed: BigInt!
  timestamp: DateTime!
  block: BigInt!
  txHash: String! @index
  chainId: Int! @index
}

# Fee Configuration

type FeeConfig @entity {
  id: ID! # "fee-config"
  feePercentage: Int!
  creatorShare: Int!
  minAmicaForReduction: BigInt!
  maxAmicaForReduction: BigInt!
  minReductionMultiplier: Int!
  maxReductionMultiplier: Int!
  lastUpdated: DateTime!
}

type UserSnapshot @entity {
  id: ID! # user address
  user: String! @unique @index
  currentBalance: BigInt!
  currentBlock: BigInt!
  pendingBalance: BigInt!
  pendingBlock: BigInt!
  lastUpdated: DateTime!
}

# NEW: Pairing Configuration Entity
type PairingConfig @entity {
  id: ID! # token address
  token: String! @unique @index
  enabled: Boolean!
  mintCost: BigInt!
  graduationThreshold: BigInt!
  lastUpdated: DateTime!
  lastUpdatedBlock: BigInt!
}

# Statistics

type GlobalStats @entity {
  id: ID! # "global"
  totalPersonas: Int!
  totalTrades: Int!
  totalBuyTrades: Int! # NEW
  totalSellTrades: Int! # NEW
  totalVolume: BigInt!
  totalBuyVolume: BigInt! # NEW
  totalSellVolume: BigInt! # NEW
  totalStakingPools: Int!
  totalStaked: BigInt!
  totalBridgeVolume: BigInt!
  lastUpdated: DateTime!
}

type DailyStats @entity {
  id: ID! # date string (YYYY-MM-DD)
  date: DateTime! @index
  newPersonas: Int!
  trades: Int!
  buyTrades: Int! # NEW
  sellTrades: Int! # NEW
  volume: BigInt!
  buyVolume: BigInt! # NEW
  sellVolume: BigInt! # NEW
  uniqueTraders: Int!
  bridgeVolume: BigInt!
}

type PersonaDailyStats @entity {
  id: ID! # personaId-date
  persona: Persona!
  date: DateTime! @index
  trades: Int!
  buyTrades: Int! # NEW
  sellTrades: Int! # NEW
  volume: BigInt!
  buyVolume: BigInt! # NEW
  sellVolume: BigInt! # NEW
  uniqueTraders: Int!
}

# NEW: Contract Configuration Entity
type ContractConfig @entity {
  id: ID! # "contract-config"
  personaFactory: String!
  stakingRewards: String
  bridgeWrapper: String
  amicaToken: String!
  lastUpdated: DateTime!
  lastUpdatedBlock: BigInt!
}
